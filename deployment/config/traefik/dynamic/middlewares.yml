# =============================================================================
# Traefik - Dynamic Configuration (Middlewares)
# =============================================================================

http:
  middlewares:
    # =========================================================================
    # Rate Limiting - Global
    # =========================================================================
    rate-limit-global:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

    # =========================================================================
    # Rate Limiting - Tier Based (per minute limits)
    # Services must add X-Customer-Tier header after JWT validation
    # =========================================================================

    # VIP Tier: 1000 requests/minute (16.67/sec)
    rate-limit-vip:
      rateLimit:
        average: 17
        burst: 50
        period: 1s
        sourceCriterion:
          requestHeaderName: "X-Request-Id"

    # Premium Tier: 500 requests/minute (8.33/sec)
    rate-limit-premium:
      rateLimit:
        average: 9
        burst: 25
        period: 1s
        sourceCriterion:
          requestHeaderName: "X-Request-Id"

    # Standard Tier: 100 requests/minute (1.67/sec)
    rate-limit-standard:
      rateLimit:
        average: 2
        burst: 10
        period: 1s
        sourceCriterion:
          requestHeaderName: "X-Request-Id"

    # =========================================================================
    # Rate Limiting - Orders API (applies to all tiers as baseline)
    # =========================================================================
    rate-limit-orders:
      rateLimit:
        average: 10
        burst: 5
        period: 1s

    # Rate Limiting - Auth API (Brute-force protection)
    rate-limit-auth:
      rateLimit:
        average: 5
        burst: 3
        period: 1s

    # Security Headers
    secure-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        frameDeny: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Robots-Tag: "noindex,nofollow,nosnippet,noarchive,notranslate,noimageindex"

    # CORS - Development
    cors-dev:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList:
          - "http://localhost:3000"
          - "http://localhost:5173"
          - "http://app.brokage.local"
        accessControlAllowCredentials: true
        accessControlMaxAge: 100
        addVaryHeader: true

    # Circuit Breaker
    circuit-breaker:
      circuitBreaker:
        expression: "ResponseCodeRatio(500, 600, 0, 600) > 0.30 || NetworkErrorRatio() > 0.10"
        checkPeriod: 10s
        fallbackDuration: 30s
        recoveryDuration: 10s

    # Retry
    retry-middleware:
      retry:
        attempts: 3
        initialInterval: 100ms

    # Strip Prefix for API
    strip-api-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # Add Request ID
    # Note: Traefik doesn't have built-in uuid function
    # Request ID is added by the service or via plugin
    add-request-id:
      headers:
        customRequestHeaders:
          X-Forwarded-By: "traefik"
