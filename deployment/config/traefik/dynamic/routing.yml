# =============================================================================
# Traefik - Dynamic Configuration (Routing)
# =============================================================================
# Static routes for all services (Docker provider fallback)
# =============================================================================

http:
  routers:
    # ---------------------------------------------------------------------------
    # API Routes (PathPrefix based)
    # ---------------------------------------------------------------------------

    # Asset Service - Assets, Stocks, Market
    asset-service:
      rule: "PathPrefix(`/api/assets`) || PathPrefix(`/api/stocks`) || PathPrefix(`/api/market`)"
      entryPoints:
        - web
      service: asset-service
      middlewares:
        - cors-dev
        - rate-limit-global
        - secure-headers

    # Order Service - Orders
    order-service:
      rule: "PathPrefix(`/api/orders`)"
      entryPoints:
        - web
      service: order-service
      middlewares:
        - cors-dev
        - rate-limit-orders
        - secure-headers

    # Customer Service - Customers
    customer-service:
      rule: "PathPrefix(`/api/customers`)"
      entryPoints:
        - web
      service: customer-service
      middlewares:
        - cors-dev
        - rate-limit-global
        - secure-headers

    # Notification Service - Notifications
    notification-service:
      rule: "PathPrefix(`/api/notifications`)"
      entryPoints:
        - web
      service: notification-service
      middlewares:
        - cors-dev
        - rate-limit-global
        - secure-headers

    # Audit Service - Audit logs
    audit-service:
      rule: "PathPrefix(`/api/audit`)"
      entryPoints:
        - web
      service: audit-service
      middlewares:
        - cors-dev
        - rate-limit-global
        - secure-headers

    # Web API - Dashboard, Analytics, Reports, SSE Streams
    web-api:
      rule: "PathPrefix(`/api/dashboard`) || PathPrefix(`/api/stream`) || PathPrefix(`/api/analytics`) || PathPrefix(`/api/reports`)"
      entryPoints:
        - web
      service: web-api
      middlewares:
        - cors-dev
        - rate-limit-global
        - secure-headers

    # ---------------------------------------------------------------------------
    # Infrastructure Routes (Host based)
    # ---------------------------------------------------------------------------

    # Keycloak - Authentication
    keycloak:
      rule: "Host(`auth.brokage.local`)"
      entryPoints:
        - web
      service: keycloak
      middlewares:
        - rate-limit-auth
        - secure-headers

    # Grafana - Monitoring Dashboard
    grafana:
      rule: "Host(`monitor.brokage.local`)"
      entryPoints:
        - web
      service: grafana

    # Kafka UI - Message Broker Management
    kafka-ui:
      rule: "Host(`kafka.brokage.local`)"
      entryPoints:
        - web
      service: kafka-ui

  services:
    # ---------------------------------------------------------------------------
    # API Services
    # ---------------------------------------------------------------------------
    asset-service:
      loadBalancer:
        servers:
          - url: "http://asset-service:8082"

    order-service:
      loadBalancer:
        servers:
          - url: "http://order-service:8081"

    customer-service:
      loadBalancer:
        servers:
          - url: "http://customer-service:8083"

    notification-service:
      loadBalancer:
        servers:
          - url: "http://notification-service:8085"

    audit-service:
      loadBalancer:
        servers:
          - url: "http://audit-service:8086"

    web-api:
      loadBalancer:
        servers:
          - url: "http://web-api:8087"

    # ---------------------------------------------------------------------------
    # Infrastructure Services
    # ---------------------------------------------------------------------------
    keycloak:
      loadBalancer:
        servers:
          - url: "http://keycloak:8080"
        healthCheck:
          path: /health/ready
          interval: 10s
          timeout: 3s

    grafana:
      loadBalancer:
        servers:
          - url: "http://lgtm:3000"
        healthCheck:
          path: /api/health
          interval: 10s
          timeout: 3s

    kafka-ui:
      loadBalancer:
        servers:
          - url: "http://kafka-ui:8080"
